<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orion Legal Guard Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .tab-active { color: #3b82f6; border-bottom: 2px solid #3b82f6; }
        .gradient-header { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); }
        .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 18px; font-size: 0.9rem; line-height: 1.4; }
        .bubble-user { background: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .bubble-ai { background: white; color: #1e293b; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .sync-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="gradient-header text-white p-4 shadow-xl shrink-0">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-500 p-2 rounded-lg shadow-inner"><i class="fas fa-gavel"></i></div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">ORION LEGAL PRO</h1>
                    <p class="text-[10px] text-blue-300 uppercase font-bold tracking-widest">AI Assisted Guardian</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="syncData()" class="p-2 hover:bg-slate-700 rounded-full transition-all"><i id="syncIcon" class="fas fa-sync-alt"></i></button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white border-b sticky top-0 z-10 flex justify-center">
        <div class="flex gap-8 text-sm font-semibold text-slate-500 p-1">
            <button onclick="showView('matters')" id="nav-matters" class="px-4 py-3 tab-active">MATTERS</button>
            <button onclick="showView('clients')" id="nav-clients" class="px-4 py-3">CLIENTS</button>
            <button onclick="showView('docs')" id="nav-docs" class="px-4 py-3">DOC GEN</button>
            <button onclick="showView('ai')" id="nav-ai" class="px-4 py-3 flex items-center gap-2">ORION AI <span class="bg-blue-100 text-blue-600 text-[9px] px-1.5 rounded-full">NEW</span></button>
        </div>
    </nav>

    <!-- Content Area -->
    <main class="flex-grow max-w-7xl mx-auto w-full p-4 md:p-6 overflow-y-auto">
        
        <!-- MATTERS VIEW -->
        <section id="view-matters" class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800">Matter Dashboard</h2>
                <button onclick="toggleModal('caseFormModal')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-500/20 transition-all hover:bg-blue-700">Add Matter</button>
            </div>
            <div class="bg-white rounded-2xl border shadow-sm overflow-hidden">
                <div class="p-4 border-b bg-slate-50"><input type="text" placeholder="Filter by Client or Ref..." class="w-full bg-white border rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-400 font-bold uppercase text-[10px]"><tr><th class="p-4">Reference</th><th class="p-4">Client</th><th class="p-4">Prescription</th><th class="p-4">Status</th><th class="p-4 text-right">Action</th></tr></thead>
                        <tbody id="mattersTableBody" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- CLIENTS VIEW -->
        <section id="view-clients" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800">Client Directory</h2>
                <button onclick="toggleModal('clientModal')" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold">New Client</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="clientsGrid"></div>
        </section>

        <!-- DOC GEN VIEW -->
        <section id="view-docs" class="hidden space-y-6 max-w-2xl mx-auto">
            <div class="text-center">
                <h2 class="text-2xl font-bold text-slate-800">Document Generator</h2>
                <p class="text-slate-500 text-sm">Select a matter to populate South African legal templates</p>
            </div>
            <div class="bg-white p-8 rounded-3xl border shadow-sm space-y-6">
                <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">1. Select Matter</label><select id="docMatterSelect" class="w-full border rounded-xl px-4 py-3 outline-none"></select></div>
                <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">2. Template Type</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="selectTemplate(this)" class="p-4 border rounded-2xl hover:border-blue-500 text-left transition-all">
                            <i class="fas fa-handshake text-blue-500 mb-2"></i><br><b class="text-sm">NDA</b><br><span class="text-[10px] text-slate-400">Non-Disclosure Agreement</span>
                        </button>
                        <button onclick="selectTemplate(this)" class="p-4 border rounded-2xl hover:border-blue-500 text-left transition-all">
                            <i class="fas fa-file-contract text-orange-500 mb-2"></i><br><b class="text-sm">SLA</b><br><span class="text-[10px] text-slate-400">Service Level Agreement</span>
                        </button>
                    </div>
                </div>
                <button onclick="generateLegalDoc()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-xl">Generate & Download PDF</button>
            </div>
        </section>

        <!-- AI ASSISTANT VIEW -->
        <section id="view-ai" class="hidden flex flex-col h-full space-y-4">
            <div class="bg-blue-600 p-4 rounded-2xl text-white flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-xl"><i class="fas fa-robot"></i></div>
                    <div><h3 class="font-bold">Orion AI</h3><p class="text-[10px] opacity-70">Gemini 2.5 Flash Enhanced</p></div>
                </div>
                <div class="flex gap-2">
                    <label class="cursor-pointer bg-white/10 p-2 rounded-lg hover:bg-white/20 transition-all">
                        <i class="fas fa-camera"></i>
                        <input type="file" id="aiVisionInput" class="hidden" accept="image/*" onchange="handleVisionUpload(this)">
                    </label>
                    <button onclick="startVoiceToText()" class="bg-white/10 p-2 rounded-lg hover:bg-white/20 transition-all"><i class="fas fa-microphone" id="micIcon"></i></button>
                </div>
            </div>
            <div id="chatWindow" class="flex-grow overflow-y-auto space-y-4 p-2 flex flex-col min-h-[400px]">
                <div class="chat-bubble bubble-ai">Hello! I can help you draft clauses, scan documents for prescription issues, or summarize case law. How can I assist today?</div>
            </div>
            <div class="flex gap-2 bg-white p-2 rounded-2xl border shadow-lg">
                <input type="text" id="aiChatInput" placeholder="Ask Orion anything..." class="flex-1 outline-none px-4 py-2 text-sm" onkeypress="if(event.key==='Enter') sendAiMessage()">
                <button onclick="sendAiMessage()" class="bg-blue-600 text-white p-3 rounded-xl"><i class="fas fa-paper-plane"></i></button>
            </div>
        </section>
    </main>

    <!-- Modal: Client -->
    <div id="clientModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8">
            <h2 class="text-xl font-bold mb-6">Register Client</h2>
            <form id="clientForm" class="space-y-4">
                <input type="text" name="Name" placeholder="Full Name / Company" required class="w-full border rounded-xl px-4 py-3">
                <input type="email" name="Email" placeholder="Email Address" required class="w-full border rounded-xl px-4 py-3">
                <input type="tel" name="Phone" placeholder="Phone Number" class="w-full border rounded-xl px-4 py-3">
                <input type="text" name="IDNumber" placeholder="ID or Registration No" class="w-full border rounded-xl px-4 py-3">
                <textarea name="Address" placeholder="Physical Address" class="w-full border rounded-xl px-4 py-3"></textarea>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="toggleModal('clientModal')" class="flex-1 py-3 font-bold text-slate-500">Cancel</button>
                    <button type="submit" class="flex-1 bg-slate-900 text-white py-3 rounded-xl font-bold">Save Client</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = ""; // SET YOUR DEPLOYED GAS URL HERE
        const apiKey = ""; // SYSTEM HANDLES THIS AT RUNTIME
        
        let matters = [];
        let clients = [];
        let selectedTemplateName = "";

        // --- NAVIGATION ---
        function showView(viewId) {
            ['matters', 'clients', 'docs', 'ai'].forEach(v => {
                document.getElementById('view-' + v).classList.add('hidden');
                document.getElementById('nav-' + v).classList.remove('tab-active');
            });
            document.getElementById('view-' + viewId).classList.remove('hidden');
            document.getElementById('nav-' + viewId).classList.add('tab-active');
        }

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }

        // --- DATA SYNC ---
        async function syncData() {
            const icon = document.getElementById('syncIcon');
            icon.classList.add('sync-spinner');
            try {
                matters = await callAPI('getMatters');
                clients = await callAPI('getClients');
                renderMatters();
                renderClients();
                populateSelects();
            } catch (e) { alert("Sync failed. Check API URL."); }
            finally { icon.classList.remove('sync-spinner'); }
        }

        async function callAPI(action, payload = null) {
            if (!API_URL) return [];
            const url = API_URL + (action.startsWith('get') ? `?action=${action}` : '');
            const options = {
                method: action.startsWith('get') ? 'GET' : 'POST',
                body: payload ? JSON.stringify({ action, payload }) : null
            };
            const res = await fetch(url, options);
            return await res.json();
        }

        // --- RENDERING ---
        function renderMatters() {
            const tbody = document.getElementById('mattersTableBody');
            tbody.innerHTML = matters.map(m => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="p-4 font-bold text-slate-800">${m.CaseRef}</td>
                    <td class="p-4">${m.ClientName}</td>
                    <td class="p-4 font-mono text-xs">${m.PrescriptionDate}</td>
                    <td class="p-4"><span class="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded-full font-bold">${m.Status}</span></td>
                    <td class="p-4 text-right"><button class="text-slate-400 hover:text-blue-500"><i class="fas fa-ellipsis-v"></i></button></td>
                </tr>
            `).join('');
        }

        function renderClients() {
            const grid = document.getElementById('clientsGrid');
            grid.innerHTML = clients.map(c => `
                <div class="bg-white p-6 rounded-3xl border shadow-sm hover:shadow-md transition-all">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-xl font-bold text-slate-400">${c.Name[0]}</div>
                        <div class="flex-1"><h4 class="font-bold text-slate-800 leading-tight">${c.Name}</h4><p class="text-[10px] text-slate-400">${c.ClientID}</p></div>
                    </div>
                    <div class="space-y-2 text-xs">
                        <p><i class="fas fa-envelope mr-2 text-blue-400"></i> ${c.Email}</p>
                        <p><i class="fas fa-phone mr-2 text-blue-400"></i> ${c.Phone || 'N/A'}</p>
                    </div>
                </div>
            `).join('');
        }

        function populateSelects() {
            const select = document.getElementById('docMatterSelect');
            select.innerHTML = '<option value="">-- Select Matter --</option>' + 
                matters.map(m => `<option value="${m.ID}">${m.CaseRef} - ${m.ClientName}</option>`).join('');
        }

        // --- CLIENT LOGIC ---
        document.getElementById('clientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            await callAPI('addClient', data);
            toggleModal('clientModal');
            syncData();
        });

        // --- DOC GEN LOGIC ---
        function selectTemplate(btn) {
            document.querySelectorAll('#view-docs button').forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50'));
            btn.classList.add('border-blue-500', 'bg-blue-50');
            selectedTemplateName = btn.querySelector('b').innerText;
        }

        async function generateLegalDoc() {
            const matterId = document.getElementById('docMatterSelect').value;
            if (!matterId || !selectedTemplateName) return alert("Select matter and template first.");
            
            const matter = matters.find(m => m.ID === matterId);
            const content = `[DRAFT] ${selectedTemplateName} \n\n CLIENT: ${matter.ClientName} \n MATTER: ${matter.MatterName} \n REF: ${matter.CaseRef} \n DATE: ${new Date().toLocaleDateString()} \n\n This document is prepared under South African Law...`;
            
            // Simple Blob Download for prototype
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${selectedTemplateName}_${matter.CaseRef}.txt`;
            a.click();
        }

        // --- ORION AI (GEMINI) ---
        async function sendAiMessage() {
            const input = document.getElementById('aiChatInput');
            const msg = input.value.trim();
            if (!msg) return;

            addBubble(msg, 'user');
            input.value = '';
            
            const aiBubble = addBubble("Thinking...", 'ai');
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `You are Orion, a specialized South African legal AI assistant. Help the user with: ${msg}. Keep responses professional and concise.` }] }]
                    })
                });
                const data = await response.json();
                aiBubble.innerText = data.candidates[0].content.parts[0].text;
            } catch (e) { aiBubble.innerText = "Error connecting to AI node. Please verify API availability."; }
        }

        function addBubble(text, type) {
            const win = document.getElementById('chatWindow');
            const b = document.createElement('div');
            b.className = `chat-bubble ${type === 'user' ? 'bubble-user' : 'bubble-ai'}`;
            b.innerText = text;
            win.appendChild(b);
            win.scrollTop = win.scrollHeight;
            return b;
        }

        async function handleVisionUpload(input) {
            const file = input.files[0];
            if (!file) return;
            addBubble(`Scanning document: ${file.name}...`, 'user');
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result.split(',')[1];
                const aiBubble = addBubble("Analyzing image for legal context...", 'ai');
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: "Analyze this document for prescription issues, dates, or liability mentions relevant to South African law." },
                                    { inlineData: { mimeType: file.type, data: base64 } }
                                ]
                            }]
                        })
                    });
                    const data = await response.json();
                    aiBubble.innerText = data.candidates[0].content.parts[0].text;
                } catch (err) { aiBubble.innerText = "Vision scan failed."; }
            };
            reader.readAsDataURL(file);
        }

        function startVoiceToText() {
            const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!Recognition) return alert("Voice not supported on this browser.");
            
            const rec = new Recognition();
            const icon = document.getElementById('micIcon');
            icon.classList.replace('fa-microphone', 'fa-spinner');
            icon.classList.add('sync-spinner');
            
            rec.onresult = (e) => {
                document.getElementById('aiChatInput').value = e.results[0][0].transcript;
                icon.classList.replace('fa-spinner', 'fa-microphone');
                icon.classList.remove('sync-spinner');
            };
            rec.start();
        }

        window.onload = syncData;
    </script>
</body>
</html>
